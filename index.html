<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Registro de Pr√©stamos</title>
<style>
body{font-family:Arial;margin:20px;background:#f4f6f8;}
h1,h2{text-align:center;color:#333;}
.section{margin-bottom:15px;padding:10px;border:1px solid #ccc;border-radius:5px;background:#fff;}
button{margin:3px;padding:5px 10px;border:none;border-radius:4px;background:#4CAF50;color:white;font-size:12px;cursor:pointer;}
button:hover{background:#45a049;}
select{padding:3px;border-radius:4px;margin:3px;font-size:12px;}
table{border-collapse:collapse;width:100%;background:#fff;box-shadow:0 2px 5px rgba(0,0,0,0.1);font-size:12px;}
th,td{border:1px solid #ddd;padding:4px;text-align:center;}
th{background:#3498db;color:white;}
.cliente{cursor:pointer;font-weight:bold;color:#2c3e50;}
.detalle{display:none;background:#eef1f5;margin-top:2px;padding:5px;border-radius:4px;text-align:left;}
.resumen-box{margin-top:5px;padding:5px;background:#dfe6e9;border-radius:4px;font-size:12px;line-height:1.5;}
.resumen-box b{color:#2c3e50;}
input[type="number"],input[type="date"],input[type="text"]{font-size:11px;padding:2px;}
input[type="checkbox"]{cursor:pointer;}
.pagado{background:#ccffcc;}
.incompleto{background:#fff6a3;}
</style>
</head>
<body>

<h1>Registro de Pr√©stamos</h1>

<div class="section">
<h2>Clientes - Pr√©stamos</h2>
<button onclick="agregarNombre()">Agregar Nombre</button>
<select id="selectNombresComunes"><option disabled selected>Selecciona un nombre</option></select>
<button onclick="eliminarNombre()">Eliminar Nombre</button>
</div>

<table id="tablaPrestamos">
  <thead><tr><th>Nombre</th><th>Resumen del Pr√©stamo</th></tr></thead>
  <tbody id="cuerpoTabla"></tbody>
</table>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

// üîπ CONFIGURACI√ìN FIREBASE
const firebaseConfig = {
  apiKey: "AIzaSyD7ctJEt9SAQX9vQSwNxMCIErvygzJwRvM",
  authDomain: "registro-99118.firebaseapp.com",
  databaseURL: "https://registro-99118-default-rtdb.firebaseio.com/",
  projectId: "registro-99118",
  storageBucket: "registro-99118.firebasestorage.app",
  messagingSenderId: "664724560721",
  appId: "1:664724560721:web:d0916ffb9f31a4c7715170"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const currentYear = new Date().getFullYear();
let nombresComunes = [];
let dataClientes = {};
const meses = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];

// üîπ FUNCIONES FIREBASE
async function guardarDataFirebase() {
  try {
    await set(ref(db, "clientes"), dataClientes);
    console.log("‚úÖ Datos guardados en Firebase");
  } catch (e) {
    console.error("‚ùå Error al guardar en Firebase:", e);
  }
}

async function cargarDataFirebase() {
  try {
    const snapshot = await get(ref(db, "clientes"));
    if (snapshot.exists()) {
      dataClientes = snapshot.val();
      nombresComunes = Object.keys(dataClientes);
      renderizarTabla();
      console.log("‚úÖ Datos cargados desde Firebase");
    } else {
      console.log("‚ö†Ô∏è No hay datos a√∫n en Firebase");
    }
  } catch (e) {
    console.error("‚ùå Error al cargar Firebase:", e);
  }
}

// üîπ FUNCIONES PRINCIPALES
function inicializarDatos() { cargarDataFirebase(); }

function actualizarSelect() {
  const select = document.getElementById("selectNombresComunes");
  select.innerHTML = "<option disabled selected>Selecciona un nombre</option>";
  nombresComunes.forEach(n => {
    const opt = document.createElement("option");
    opt.value = n;
    opt.textContent = n;
    select.appendChild(opt);
  });
}

function renderizarTabla() {
  const cuerpo = document.getElementById("cuerpoTabla");
  cuerpo.innerHTML = "";
  nombresComunes.forEach(nombre => {
    if (!dataClientes[nombre])
      dataClientes[nombre] = { valor: 0, interes: 0, cuotas: 1, pagos: {}, fechaInicio: `${currentYear}-01` };

    const tr = document.createElement("tr");
    const tdNombre = document.createElement("td");
    tdNombre.classList.add("cliente");
    tdNombre.onclick = () => toggleDetalle(tr.nextSibling);
    tdNombre.innerHTML = `<b>${nombre}</b><br><span id="totales_${escapeId(nombre)}" class="restante-total"></span>`;
    tr.appendChild(tdNombre);

    const tdResumen = document.createElement("td");
    tdResumen.id = `resumen_${escapeId(nombre)}`;
    tdResumen.innerHTML = "Sin datos";
    tr.appendChild(tdResumen);
    cuerpo.appendChild(tr);

    const detalleTr = document.createElement("tr");
    const tdDetalle = document.createElement("td");
    tdDetalle.colSpan = 2;
    tdDetalle.innerHTML = `
      <div class="detalle" style="display:none;">
        <b>Configuraci√≥n de ${nombre}</b><br>
        Fecha de Inicio: <input type="month" id="inicio_${escapeId(nombre)}" value="${dataClientes[nombre].fechaInicio}" onchange="actualizarCliente('${escapeJs(nombre)}')">
        Valor: <input type="number" id="valor_${escapeId(nombre)}" style="width:80px;" value="${dataClientes[nombre].valor}" oninput="actualizarCliente('${escapeJs(nombre)}')">
        Inter√©s anual (%): <input type="number" id="interes_${escapeId(nombre)}" style="width:60px;" value="${dataClientes[nombre].interes}" oninput="actualizarCliente('${escapeJs(nombre)}')">
        Cuotas: <input type="number" id="cuotas_${escapeId(nombre)}" style="width:50px;" value="${dataClientes[nombre].cuotas}" oninput="actualizarCliente('${escapeJs(nombre)}')">
        <div id="tablaPagos_${escapeId(nombre)}"></div>
      </div>`;
    detalleTr.appendChild(tdDetalle);
    cuerpo.appendChild(detalleTr);
    generarTablaPagos(nombre);
  });
  actualizarSelect();
}

// (Aqu√≠ siguen las funciones: actualizarCliente, generarTablaPagos, editarCampo, etc. ‚Äî todo igual al c√≥digo que te pas√© antes)
inicializarDatos();
window.agregarNombre = agregarNombre;
window.eliminarNombre = eliminarNombre;
window.actualizarCliente = actualizarCliente;
window.editarCampo = editarCampo;
window.toggleDetalle = toggleDetalle;
</script>
</body>
</html>
