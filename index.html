<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Registro de Pr√©stamos</title>
<style>
body{font-family:Arial;margin:20px;background:#f4f6f8;}
h1,h2{text-align:center;color:#333;}
.section{margin-bottom:15px;padding:10px;border:1px solid #ccc;border-radius:5px;background:#fff;}
button{margin:3px;padding:5px 10px;border:none;border-radius:4px;background:#4CAF50;color:white;font-size:12px;cursor:pointer;}
button:hover{background:#45a049;}
select{padding:3px;border-radius:4px;margin:3px;font-size:12px;}
table{border-collapse:collapse;width:100%;background:#fff;box-shadow:0 2px 5px rgba(0,0,0,0.1);font-size:12px;}
th,td{border:1px solid #ddd;padding:4px;text-align:center;}
th{background:#3498db;color:white;}
.cliente{cursor:pointer;font-weight:bold;color:#2c3e50;}
.detalle{display:none;background:#eef1f5;margin-top:2px;padding:5px;border-radius:4px;text-align:left;}
.resumen-box{margin-top:5px;padding:5px;background:#dfe6e9;border-radius:4px;font-size:12px;line-height:1.5;}
.resumen-box b{color:#2c3e50;}
input[type="number"],input[type="date"],input[type="text"]{font-size:11px;padding:2px;}
input[type="checkbox"]{cursor:pointer;}
.pagado{background:#ccffcc;}
.incompleto{background:#fff6a3;}
</style>
</head>
<body>

<h1>Registro de Pr√©stamos</h1>

<div class="section">
<h2>Clientes - Pr√©stamos</h2>
<button onclick="agregarNombre()">Agregar Nombre</button>
<select id="selectNombresComunes"><option disabled selected>Selecciona un nombre</option></select>
<button onclick="eliminarNombre()">Eliminar Nombre</button>
</div>

<table id="tablaPrestamos">
  <thead><tr><th>Nombre</th><th>Resumen del Pr√©stamo</th></tr></thead>
  <tbody id="cuerpoTabla"></tbody>
</table>

<script>
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

// üîπ CONFIGURACI√ìN FIREBASE
const firebaseConfig = {
  apiKey: "AIzaSyD7ctJEt9SAQX9vQSwNxMCIErvygzJwRvM",
  authDomain: "registro-99118.firebaseapp.com",
  databaseURL: "https://registro-99118-default-rtdb.firebaseio.com/",
  projectId: "registro-99118",
  storageBucket: "registro-99118.firebasestorage.app",
  messagingSenderId: "664724560721",
  appId: "1:664724560721:web:d0916ffb9f31a4c7715170"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// üîπ VARIABLES
const currentYear = new Date().getFullYear();
let nombresComunes = [];
let dataClientes = {};
const meses = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];

// üîπ FUNCIONES FIREBASE
async function guardarDataFirebase() {
  try {
    await set(ref(db, "clientes"), dataClientes);
    console.log("‚úÖ Datos guardados en Firebase");
  } catch (e) {
    console.error("‚ùå Error al guardar en Firebase:", e);
  }
}

async function cargarDataFirebase() {
  try {
    const snapshot = await get(ref(db, "clientes"));
    if (snapshot.exists()) {
      dataClientes = snapshot.val();
      nombresComunes = Object.keys(dataClientes);
      renderizarTabla();
      console.log("‚úÖ Datos cargados desde Firebase");
    } else {
      console.log("‚ö†Ô∏è No hay datos a√∫n en Firebase");
    }
  } catch (e) {
    console.error("‚ùå Error al cargar Firebase:", e);
  }
}

// üîπ FUNCIONES PRINCIPALES
function inicializarDatos() { cargarDataFirebase(); }

function actualizarSelect() {
  const select = document.getElementById("selectNombresComunes");
  select.innerHTML = "<option disabled selected>Selecciona un nombre</option>";
  nombresComunes.forEach(n => {
    const opt = document.createElement("option");
    opt.value = n;
    opt.textContent = n;
    select.appendChild(opt);
  });
}

function renderizarTabla() {
  const cuerpo = document.getElementById("cuerpoTabla");
  cuerpo.innerHTML = "";
  nombresComunes.forEach(nombre => {
    if (!dataClientes[nombre])
      dataClientes[nombre] = { valor: 0, interes: 0, cuotas: 1, pagos: {}, fechaInicio: `${currentYear}-01` };

    const tr = document.createElement("tr");
    const tdNombre = document.createElement("td");
    tdNombre.classList.add("cliente");
    tdNombre.onclick = () => toggleDetalle(tr.nextSibling);
    tdNombre.innerHTML = `<b>${nombre}</b><br><span id="totales_${escapeId(nombre)}" class="restante-total"></span>`;
    tr.appendChild(tdNombre);

    const tdResumen = document.createElement("td");
    tdResumen.id = `resumen_${escapeId(nombre)}`;
    tdResumen.innerHTML = "Sin datos";
    tr.appendChild(tdResumen);
    cuerpo.appendChild(tr);

    const detalleTr = document.createElement("tr");
    const tdDetalle = document.createElement("td");
    tdDetalle.colSpan = 2;
    tdDetalle.innerHTML = `
      <div class="detalle" style="display:none;">
        <b>Configuraci√≥n de ${nombre}</b><br>
        Fecha de Inicio: <input type="month" id="inicio_${escapeId(nombre)}" value="${dataClientes[nombre].fechaInicio}" onchange="actualizarCliente('${escapeJs(nombre)}')">
        Valor: <input type="number" id="valor_${escapeId(nombre)}" style="width:80px;" value="${dataClientes[nombre].valor}" oninput="actualizarCliente('${escapeJs(nombre)}')">
        Inter√©s anual (%): <input type="number" id="interes_${escapeId(nombre)}" style="width:60px;" value="${dataClientes[nombre].interes}" oninput="actualizarCliente('${escapeJs(nombre)}')">
        Cuotas: <input type="number" id="cuotas_${escapeId(nombre)}" style="width:50px;" value="${dataClientes[nombre].cuotas}" oninput="actualizarCliente('${escapeJs(nombre)}')">
        <div id="tablaPagos_${escapeId(nombre)}"></div>
      </div>`;
    detalleTr.appendChild(tdDetalle);
    cuerpo.appendChild(detalleTr);
    generarTablaPagos(nombre);
  });
  actualizarSelect();
}

function actualizarCliente(nombre) {
  const c = dataClientes[nombre];
  c.valor = parseFloat(document.getElementById(`valor_${escapeId(nombre)}`).value) || 0;
  c.interes = parseFloat(document.getElementById(`interes_${escapeId(nombre)}`).value) || 0;
  c.cuotas = parseInt(document.getElementById(`cuotas_${escapeId(nombre)}`).value) || 1;
  c.fechaInicio = document.getElementById(`inicio_${escapeId(nombre)}`).value;
  guardarData();
  generarTablaPagos(nombre);
}

function generarTablaPagos(nombre) {
  const c = dataClientes[nombre];
  const tasaMensual = c.interes / 12 / 100;
  const valor = c.valor;
  const n = c.cuotas;
  const cuotaFija = (tasaMensual > 0 && n > 0)
    ? (valor * tasaMensual) / (1 - Math.pow(1 + tasaMensual, -n))
    : (n > 0 ? valor / n : 0);
  let saldo = valor, totalPagado = 0, totalIntereses = 0, cuotasPagadas = 0;
  const contenedor = document.getElementById(`tablaPagos_${escapeId(nombre)}`);
  let html = `<div class='resumen-box'>
    <b>Valor pr√©stamo:</b> $${valor.toFixed(2)} |
    <b>Inter√©s anual:</b> ${c.interes.toFixed(2)}% |
    <b>Cuotas:</b> ${c.cuotas} |
    <b>Cuota fija:</b> $${cuotaFija.toFixed(2)}
  </div>`;
  html += `<table style="width:100%;margin-top:5px;">
  <tr><th>Mes</th><th>A√±o</th><th>Fecha</th><th>Inter√©s</th><th>Capital</th><th>Saldo</th><th>Pagado</th><th>Pago Incompleto</th><th>Abono Extra</th><th>Pendiente</th><th>Observaciones</th></tr>`;
  const [anioInicio, mesInicio] = c.fechaInicio.split('-').map(Number);
  let mes = (isNaN(mesInicio) ? 0 : mesInicio - 1),
      anio = (isNaN(anioInicio) ? currentYear : anioInicio);
  let abonoExtraPendiente = 0;
  for (let i = 0; i < n; i++) {
    const key = `${anio}_${meses[mes]}`;
    if (!c.pagos[key]) c.pagos[key] = { fecha: "", pagado: false, incompleto: 0, extra: 0, obs: "" };
    const p = c.pagos[key];
    const interesMes = saldo * tasaMensual;
    let capitalMes = cuotaFija - interesMes;
    if (capitalMes < 0) capitalMes = 0;
    capitalMes += abonoExtraPendiente; abonoExtraPendiente = 0;
    let nuevoSaldo = saldo - capitalMes; if (nuevoSaldo < 0) nuevoSaldo = 0;
    totalIntereses += interesMes;
    const pagoCompleto = p.pagado ? cuotaFija : 0;
    const pagoIncompleto = parseFloat(p.incompleto) || 0;
    const abonoExtra = parseFloat(p.extra) || 0;
    const pendiente = Math.max(0, cuotaFija - (pagoCompleto + pagoIncompleto + abonoExtra));
    totalPagado += pagoCompleto + pagoIncompleto + abonoExtra;
    if (p.pagado) cuotasPagadas++;
    abonoExtraPendiente += abonoExtra;
    const clase = p.pagado ? 'pagado' : (pagoIncompleto > 0 ? 'incompleto' : '');
    const idKey = escapeId(key);
    html += `<tr class="${clase}">
      <td>${meses[mes]}</td><td>${anio}</td>
      <td><input type="date" id="fecha_${escapeId(nombre)}_${idKey}" value="${p.fecha}" onchange="editarCampo('${escapeJs(nombre)}','${escapeJs(key)}','fecha',this.value)"></td>
      <td>$${interesMes.toFixed(2)}</td><td>$${capitalMes.toFixed(2)}</td><td>$${nuevoSaldo.toFixed(2)}</td>
      <td><input type="checkbox" id="check_${escapeId(nombre)}_${idKey}" ${p.pagado ? "checked" : ""} onchange="editarCampo('${escapeJs(nombre)}','${escapeJs(key)}','pagado',this.checked)"></td>
      <td><input type="number" id="incompleto_${escapeId(nombre)}_${idKey}" min="0" value="${pagoIncompleto}" oninput="editarCampo('${escapeJs(nombre)}','${escapeJs(key)}','incompleto',this.value)" style="width:70px;text-align:right;"></td>
      <td><input type="number" id="extra_${escapeId(nombre)}_${idKey}" min="0" value="${abonoExtra}" oninput="editarCampo('${escapeJs(nombre)}','${escapeJs(key)}','extra',this.value)" style="width:70px;text-align:right;"></td>
      <td>$${pendiente.toFixed(2)}</td>
      <td><input type="text" id="obs_${escapeId(nombre)}_${idKey}" value="${p.obs}" oninput="editarCampo('${escapeJs(nombre)}','${escapeJs(key)}','obs',this.value)" style="width:100px;"></td>
    </tr>`;
    saldo = nuevoSaldo; mes++; if (mes > 11) { mes = 0; anio++; }
  }
  html += "</table>";
  contenedor.innerHTML = html;
  const resumen = document.getElementById(`resumen_${escapeId(nombre)}`);
  const totalPendiente = Math.max(0, valor + totalIntereses - totalPagado);
  resumen.innerHTML = `<div class="resumen-box">
  <b>Total intereses:</b> $${totalIntereses.toFixed(2)} |
  <b>Total pagado:</b> $${totalPagado.toFixed(2)} |
  <b>Pendiente:</b> $${totalPendiente.toFixed(2)}</div>`;
  guardarData();
}

function editarCampo(nombre,key,campo,valor){
  const c=dataClientes[nombre];
  if(!c.pagos[key]) c.pagos[key]={fecha:"",pagado:false,incompleto:0,extra:0,obs:""};
  if(campo==="pagado") c.pagos[key].pagado=!!valor;
  else if(["fecha","obs"].includes(campo)) c.pagos[key][campo]=valor;
  else c.pagos[key][campo]=parseFloat(valor)||0;
  guardarData(); generarTablaPagos(nombre);
}

function toggleDetalle(tr){const d=tr.querySelector(".detalle");d.style.display=d.style.display==="none"?"block":"none";}
function guardarData(){localStorage.setItem("clientes",JSON.stringify(dataClientes)); guardarDataFirebase();}
function agregarNombre(){const n=prompt("Ingrese nombre:");if(n&&!nombresComunes.includes(n)){nombresComunes.push(n);dataClientes[n]={valor:0,interes:0,cuotas:1,pagos:{},fechaInicio:`${currentYear}-01`};guardarData();renderizarTabla();}}
function eliminarNombre(){const sel=document.getElementById("selectNombresComunes");const n=sel.value;if(n){delete dataClientes[n];nombresComunes=nombresComunes.filter(x=>x!==n);guardarData();renderizarTabla();}else alert("Selecciona un nombre para eliminar.");}
function escapeId(s){return String(s).replace(/\s+/g,"_").replace(/[^a-zA-Z0-9_\-]/g,"");}
function escapeJs(s){return String(s).replace(/\\/g,"\\\\").replace(/'/g,"\\'");}

inicializarDatos();

// ‚úÖ Exponer funciones globales
window.agregarNombre = agregarNombre;
window.eliminarNombre = eliminarNombre;
window.actualizarCliente = actualizarCliente;
window.editarCampo = editarCampo;
window.toggleDetalle = toggleDetalle;
</script>
</body>
</html>
